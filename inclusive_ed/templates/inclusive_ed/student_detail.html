{% extends "base.html" %}
{% load cft_display inclusive_ed_perms %}

{% block title %}Student — {{ student.last_name }}, {{ student.first_name }}{% endblock %}

{% block content %}

<div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
  <div>
    <h1 class="h4 mb-0">
      {{ student.first_name }} {{ student.last_name }}
    </h1>
    <div class="small text-body-secondary">
      Date of birth: {{ student.date_of_birth|date:"Y-m-d" }}
      {% if student.current_school_names %}
        · Current school(s): {{ student.current_school_names }}
      {% endif %}
    </div>
  </div>
  <div class="d-flex gap-2">
    <a href="{% url 'inclusive_ed:student_list' %}" class="btn btn-sm btn-outline-secondary">
      &larr; Back to students
    </a>
    {% if user|can_edit_student %}
      <a href="{% url 'inclusive_ed:student_edit' student.pk %}"
        class="btn btn-sm btn-primary">
        Edit profile
      </a>
    {% endif %}
  </div>
</div>

<div class="row g-3">

  <!-- Profile / audit summary -->
  <div class="col-12 col-xl-4">
    <div class="card shadow-sm h-100">
      <div class="card-header">
        <h2 class="h6 mb-0">Student profile</h2>
      </div>
      <div class="card-body small">
        <dl class="row mb-2">
          <dt class="col-5 col-sm-4">Name</dt>
          <dd class="col-7 col-sm-8">
            {{ student.first_name }} {{ student.last_name }}
          </dd>

          <dt class="col-5 col-sm-4">Date of birth</dt>
          <dd class="col-7 col-sm-8">
            {{ student.date_of_birth|date:"Y-m-d" }}
          </dd>

          <dt class="col-5 col-sm-4">Current school(s)</dt>
          <dd class="col-7 col-sm-8">
            {% if student.current_school_names %}
              {{ student.current_school_names }}
            {% else %}
              <span class="text-body-secondary">None recorded</span>
            {% endif %}
          </dd>
        </dl>

        <hr>

        <dl class="row mb-0">
          <dt class="col-5 col-sm-4">Created</dt>
          <dd class="col-7 col-sm-8">
            {{ student.created_at|date:"Y-m-d" }}
            {% if student.created_by %}
              <span class="text-body-secondary">
                · by {{ student.created_by.full_name|default:student.created_by.username }}
              </span>
            {% endif %}
          </dd>

          <dt class="col-5 col-sm-4">Last updated</dt>
          <dd class="col-7 col-sm-8">
            {{ student.last_updated_at|date:"Y-m-d" }}
            {% if student.last_updated_by %}
              <span class="text-body-secondary">
                · by {{ student.last_updated_by.full_name|default:student.last_updated_by.username }}
              </span>
            {% endif %}
          </dd>
        </dl>
      </div>
    </div>
  </div>

  <!-- School enrolments -->
  <div class="col-12 col-xl-8">
    <div class="card shadow-sm h-100">
      <div class="card-header d-flex align-items-center justify-content-between">
        <h2 class="h6 mb-0">Enrolments &amp; disability data</h2>
        <div class="d-flex align-items-center gap-2">
          <span class="badge text-bg-light text-body-secondary">
            {{ student.enrolments.count }} total
          </span>
          {% if user|can_edit_student %}
            <a href="{% url 'inclusive_ed:student_enrolment_add' student.pk %}"
               class="btn btn-sm btn-primary">
               Add Enrolment
            </a>
          {% endif %}
        </div>
      </div>
      
      <div class="card-body p-0">
        {% if enrolments %}
          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th scope="col">School</th>
                  <th scope="col">School year</th>
                  <th scope="col">Class level</th>
                  {% comment %} <th scope="col">Start/End Dates</th> {% endcomment %}
                  <th scope="col" class="text-end">Status &amp; audit</th>
                  {% if user|can_edit_student %}
                    <th scope="col" class="text-end">Actions</th>
                  {% endif %}
                </tr>
              </thead>
              <tbody>
                {% for e in enrolments %}
                  <tr>
                    <td>
                      <div class="fw-semibold">
                        {{ e.school.emis_school_name }}
                      </div>
                      <div class="small text-body-secondary">
                        {{ e.school.emis_school_no }}
                      </div>
                    </td>
                    <td>
                      {% if e.school_year %}
                        {% if e.school_year.label %}{{ e.school_year.label }}{% else %}{{ e.school_year.code }}{% endif %}
                      {% else %}
                        <span class="text-body-secondary">—</span>
                      {% endif %}
                    </td>
                    <td>
                      {% if e.class_level %}
                        {{ e.class_level.code }}{% if e.class_level.label %} — {{ e.class_level.label }}{% endif %}
                      {% else %}
                        <span class="text-body-secondary">—</span>
                      {% endif %}
                    </td>
                    {% comment %} <td class="small">
                      {% if e.start_date %}
                        From {{ e.start_date|date:"Y-m-d" }}
                      {% else %}
                        From <span class="text-body-secondary">—</span>
                      {% endif %}
                      <br>
                      {% if e.end_date %}
                        To {{ e.end_date|date:"Y-m-d" }}
                      {% else %}
                        To <span class="text-body-secondary">open-ended</span>
                      {% endif %}
                    </td> {% endcomment %}
                    <td class="text-end small">
                      <div class="mb-1">
                        {% if e.is_active %}
                          <span class="badge text-bg-success">Active</span>
                        {% else %}
                          <span class="badge text-bg-secondary">Inactive</span>
                        {% endif %}
                      </div>

                      {% if e.created_at %}
                        <div class="text-body-secondary">
                          Created {{ e.created_at|date:"Y-m-d" }}
                          {% if e.created_by %}
                            <span>
                              · by {{ e.created_by.get_full_name|default:e.created_by.username }}
                            </span>
                          {% endif %}
                        </div>
                      {% endif %}

                      {% if e.last_updated_at %}
                        <div class="text-body-secondary">
                          Updated {{ e.last_updated_at|date:"Y-m-d" }}
                          {% if e.last_updated_by %}
                            <span>
                              · by {{ e.last_updated_by.get_full_name|default:e.last_updated_by.username }}
                            </span>
                          {% endif %}
                        </div>
                      {% endif %}
                    </td>
                    {% if user|can_edit_student %}
                      <td class="text-end">
                        <a href="{% url 'inclusive_ed:student_enrolment_edit' student.pk e.pk %}"
                          class="btn btn-sm btn-outline-secondary me-1">
                          Edit
                        </a>
                        {% if user|can_delete_student:student %}
                        <a href="{% url 'inclusive_ed:student_enrolment_delete' student.pk e.pk %}"
                          class="btn btn-sm btn-outline-danger">
                          Delete
                        </a>
                        {% endif %}
                      </td>
                    {% endif %}
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="p-3 text-center text-body-secondary small">
            No enrolments recorded for this student.
          </div>
        {% endif %}
      </div>
    </div>
  </div>

</div>

{# Latest questionnaire & disability data #}
<div class="row g-3 mt-1">
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-header d-flex align-items-center justify-content-between">
        <h2 class="h6 mb-0">Questionnaire &amp; disability data</h2>
        {% if latest_enrolment %}
          <span class="badge text-bg-light text-body-secondary">
            Latest data is from enrolment: School Year {{ latest_enrolment.school_year.code }} at {{ latest_enrolment.school.emis_school_name }}
          </span>
        {% endif %}
      </div>
      <div class="card-body small">
        {% if latest_enrolment %}
          <div class="row">
            <div class="col-12 col-md-6">
              <h3 class="h6">Seeing &amp; hearing</h3>
              <dl class="row mb-3">
                <dt class="col-6">Wears glasses / contacts</dt>
                <dd class="col-6">
                  {% if latest_enrolment.cft1_wears_glasses is not None %}
                    {{ latest_enrolment.cft1_wears_glasses|cft_yesno_badge|safe }}
                  {% else %}
                    <span class="text-body-secondary">Not recorded</span>
                  {% endif %}
                </dd>

                <dt class="col-6">Difficulty seeing with glasses</dt>
                <dd class="col-6">
                  {% if latest_enrolment.cft2_difficulty_seeing_with_glasses is not None %}
                    {{ latest_enrolment.cft2_difficulty_seeing_with_glasses|cft_difficulty_badge|safe }}
                  {% else %}
                    <span class="text-body-secondary">Not recorded</span>
                  {% endif %}
                </dd>

                <dt class="col-6">Difficulty seeing (overall)</dt>
                <dd class="col-6">
                  {% if latest_enrolment.cft3_difficulty_seeing is not None %}
                    {{ latest_enrolment.cft3_difficulty_seeing|cft_difficulty_badge|safe }}
                  {% else %}
                    <span class="text-body-secondary">Not recorded</span>
                  {% endif %}
                </dd>

                <dt class="col-6">Uses hearing aid</dt>
                <dd class="col-6">
                  {% if latest_enrolment.cft4_has_hearing_aids is not None %}
                    {{ latest_enrolment.cft4_has_hearing_aids|cft_difficulty_badge|safe }}
                  {% else %}
                    <span class="text-body-secondary">Not recorded</span>
                  {% endif %}
                </dd>

                <dt class="col-6">Difficulty hearing with aid</dt>
                <dd class="col-6">
                  {% if latest_enrolment.cft5_difficulty_hearing_with_aids is not None %}
                    {{ latest_enrolment.cft5_difficulty_hearing_with_aids|cft_difficulty_badge|safe }}
                  {% else %}
                    <span class="text-body-secondary">Not recorded</span>
                  {% endif %}
                </dd>

                <dt class="col-6">Difficulty hearing (overall)</dt>
                <dd class="col-6">
                  {% if latest_enrolment.cft6_difficulty_hearing is not None %}
                    {{ latest_enrolment.cft6_difficulty_hearing|cft_difficulty_badge|safe }}
                  {% else %}
                    <span class="text-body-secondary">Not recorded</span>
                  {% endif %}
                </dd>
              </dl>

              <h3 class="h6">Mobility &amp; fine motor</h3>
              <dl class="row mb-0">
                <dt class="col-6">Uses walking equipment / assistance</dt>
                <dd class="col-6">
                  {% if latest_enrolment.cft7_uses_walking_equipment is not None %}
                    {{ latest_enrolment.cft7_uses_walking_equipment|cft_difficulty_badge|safe }}
                  {% else %}
                    <span class="text-body-secondary">Not recorded</span>
                  {% endif %}
                </dd>

                <dt class="col-6">Difficulty walking without equipment</dt>
                <dd class="col-6">
                  {% if latest_enrolment.cft8_difficulty_walking_without_equipment is not None %}
                    {{ latest_enrolment.cft8_difficulty_walking_without_equipment|cft_difficulty_badge|safe }}
                  {% else %}
                    <span class="text-body-secondary">Not recorded</span>
                  {% endif %}
                </dd>

                <dt class="col-6">Difficulty walking with equipment</dt>
                <dd class="col-6">
                  {% if latest_enrolment.cft9_difficulty_walking_with_equipment is not None %}
                    {{ latest_enrolment.cft9_difficulty_walking_with_equipment|cft_difficulty_badge|safe }}
                  {% else %}
                    <span class="text-body-secondary">Not recorded</span>
                  {% endif %}
                </dd>

                <dt class="col-6">Difficulty walking vs same-age peers</dt>
                <dd class="col-6">
                  {% if latest_enrolment.cft10_difficulty_walking_compare_to_others is not None %}
                    {{ latest_enrolment.cft10_difficulty_walking_compare_to_others|cft_difficulty_badge|safe }}
                  {% else %}
                    <span class="text-body-secondary">Not recorded</span>
                  {% endif %}
                </dd>

                <dt class="col-6">Picking up small objects</dt>
                <dd class="col-6">
                  {% if latest_enrolment.cft11_difficulty_picking_up_small_objects is not None %}
                    {{ latest_enrolment.cft11_difficulty_picking_up_small_objects|cft_difficulty_badge|safe }}
                  {% else %}
                    <span class="text-body-secondary">Not recorded</span>
                  {% endif %}
                </dd>
              </dl>
            </div>

            <div class="col-12 col-md-6">
              <h3 class="h6">Communication &amp; learning</h3>
              <dl class="row mb-3">
                <dt class="col-6">Being understood by others</dt>
                <dd class="col-6">
                  {% if latest_enrolment.cft12_difficulty_being_understood is not None %}
                    {{ latest_enrolment.cft12_difficulty_being_understood|cft_difficulty_badge|safe }}
                  {% else %}
                    <span class="text-body-secondary">Not recorded</span>
                  {% endif %}
                </dd>

                <dt class="col-6">Learning</dt>
                <dd class="col-6">
                  {% if latest_enrolment.cft13_difficulty_learning is not None %}
                    {{ latest_enrolment.cft13_difficulty_learning|cft_difficulty_badge|safe }}
                  {% else %}
                    <span class="text-body-secondary">Not recorded</span>
                  {% endif %}
                </dd>

                <dt class="col-6">Remembering</dt>
                <dd class="col-6">
                  {% if latest_enrolment.cft14_difficulty_remembering is not None %}
                    {{ latest_enrolment.cft14_difficulty_remembering|cft_difficulty_badge|safe }}
                  {% else %}
                    <span class="text-body-secondary">Not recorded</span>
                  {% endif %}
                </dd>

                <dt class="col-6">Concentrating</dt>
                <dd class="col-6">
                  {% if latest_enrolment.cft15_difficulty_concentrating is not None %}
                    {{ latest_enrolment.cft15_difficulty_concentrating|cft_difficulty_badge|safe }}
                  {% else %}
                    <span class="text-body-secondary">Not recorded</span>
                  {% endif %}
                </dd>

                <dt class="col-6">Accepting change in routine</dt>
                <dd class="col-6">
                  {% if latest_enrolment.cft16_difficulty_accepting_change is not None %}
                    {{ latest_enrolment.cft16_difficulty_accepting_change|cft_difficulty_badge|safe }}
                  {% else %}
                    <span class="text-body-secondary">Not recorded</span>
                  {% endif %}
                </dd>
              </dl>

              <h3 class="h6">Behaviour, social &amp; emotional</h3>
              <dl class="row mb-0">
                <dt class="col-6">Controlling behaviour</dt>
                <dd class="col-6">
                  {% if latest_enrolment.cft17_difficulty_controlling_behaviour is not None %}
                    {{ latest_enrolment.cft17_difficulty_controlling_behaviour|cft_difficulty_badge|safe }}
                  {% else %}
                    <span class="text-body-secondary">Not recorded</span>
                  {% endif %}
                </dd>

                <dt class="col-6">Making friends</dt>
                <dd class="col-6">
                  {% if latest_enrolment.cft18_difficulty_making_friends is not None %}
                    {{ latest_enrolment.cft18_difficulty_making_friends|cft_difficulty_badge|safe }}
                  {% else %}
                    <span class="text-body-secondary">Not recorded</span>
                  {% endif %}
                </dd>

                <dt class="col-6">Anxiety (frequency)</dt>
                <dd class="col-6">
                  {% if latest_enrolment.cft19_anxious_frequency is not None %}
                    {{ latest_enrolment.cft19_anxious_frequency|cft_emotional_badge|safe }}
                  {% else %}
                    <span class="text-body-secondary">Not recorded</span>
                  {% endif %}
                </dd>

                <dt class="col-6">Depression (frequency)</dt>
                <dd class="col-6">
                  {% if latest_enrolment.cft20_depressed_frequency is not None %}
                    {{ latest_enrolment.cft20_depressed_frequency|cft_emotional_badge|safe }}
                  {% else %}
                    <span class="text-body-secondary">Not recorded</span>
                  {% endif %}
                </dd>
              </dl>
            </div>
          </div>
        {% else %}
          <p class="mb-0 text-body-secondary">
            No questionnaire or disability data recorded yet for this student.
          </p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

{% endblock %}
